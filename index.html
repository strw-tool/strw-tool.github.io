<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Straßenwärter Tool</title>

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
  <link rel="shortcut icon" href="assets/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Strw-Tool" />
  <link rel="manifest" href="assets/site.webmanifest" />
  <meta name="theme-color" content="#1f2937" />

  <!-- Styles -->
  <link rel="stylesheet" href="styles/index.css" />
  <link rel="stylesheet" href="styles/dashboard.css" />
  <link rel="stylesheet" href="styles/report.css" />
  <link rel="stylesheet" href="styles/projectdoc.css" />
  <link rel="stylesheet" href="styles/auth.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="styles/arp.css" />

  <!-- Splash minimal -->
  <style>
    .splash-screen{position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(15,23,42,.95),rgba(2,6,23,.98));display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:9999}
    .splash-screen.hide{opacity:0;visibility:hidden;transition:opacity 1.2s ease}
    .splash-screen img{width:120px}
    .splash-screen h1{margin-top:1rem;font-size:1.5rem}
    .splash-screen p{color:#93c5fd}
  </style>
</head>

<body class="auth-locked">
  <!-- === SPLASH === -->
  <div id="splash" class="splash-screen">
    <img src="assets/logo.png" alt="Logo Straßenwärter Tool" />
    <h1>Straßenwärter Tool</h1>
    <p>das digitale Tool für Straßenwärter</p>
  </div>

  <!-- === LOGIN === -->
  <div id="loginOverlay" class="active" aria-modal="true" role="dialog" aria-label="Anmeldung erforderlich">
    <div class="login-card" role="document">
      <h2>🔒 Anmelden</h2>
      <p>Zugriff nur für autorisierte Benutzer.</p>
      <div class="login-field">
        <label for="loginUser">Benutzername</label>
        <input id="loginUser" autocomplete="username" placeholder="Benutzername" />
      </div>
      <div class="login-field">
        <label for="loginPass">Passwort</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="Passwort" />
      </div>
      <div class="login-actions">
        <label class="login-small"><input type="checkbox" id="rememberMe" /> auf diesem Gerät merken</label>
        <div><button id="loginBtn" class="btn">Anmelden</button></div>
      </div>
      <div id="loginError" class="login-error" aria-live="polite"></div>
    </div>
  </div>

  <!-- === APP === -->
  <div id="app" aria-hidden="true">
    <div class="top-logo">
      <img src="assets/logo.png" alt="Logo Straßenwärter Tool" />
      <div class="top-logo-text">
        <h1>Straßenwärter Tool</h1>
        <p>das digitale Tool für Straßenwärter</p>
      </div>
    </div>

    <!-- === NAVIGATION === -->
    <nav id="mainNav">
      <div class="nav-container">
        <button id="mobileNavToggle" class="mobile-nav-toggle" aria-label="Menü öffnen">☰</button>
        <ul class="nav-menu" id="navMenu">
          <li class="nav-item">
            <a href="#" data-tab="dashboard" class="active">🏠 Dashboard</a>
            <div class="dropdown">
              <a href="#" data-tab="rsa">🚧 RSA</a>
              <a href="#" data-tab="signs">🚦 Schilderwald</a>
              <a href="#" data-tab="infos">ℹ️ Informationen</a>
            </div>
          </li>

          <li class="nav-item">
            <a href="#">🧮 Rechner</a>
            <div class="dropdown">
              <a href="#" data-tab="calc">📏 Rechnungen Arbeitsalltag</a>
              <a href="#" data-tab="worktime">🕓 Arbeitszeitrechner</a>
              <a href="#" data-tab="schoolcalc">🏫 Rechnungen Schule</a>
              <a href="#" data-tab="winter">❄️ Winterdienst</a>
            </div>
          </li>

          <li class="nav-item">
            <a href="#">🧾 Berichte</a>
            <div class="dropdown">
              <a href="#" data-tab="report">📘 Tagesbericht</a>
              <a href="#" data-tab="ausbildungsnachweis">📚 Ausbildungsnachweis</a>
              <a href="#" data-tab="arp">🧾 ARP-Nummern</a>
              <a href="#" data-tab="projectdoc">📋 Projektdokumentation</a>
              <a href="#" data-tab="maengel">🚨 Mängelmeldung</a>
            </div>
          </li>

          <li class="nav-item">
            <a href="#">📂 Wissensbox</a>
            <div class="dropdown">
              <a href="#" data-tab="roterordner">📕 Roter Ordner</a>
              <a href="#" data-tab="schildhoehen">📏 Schilderhöhen & Abstände</a>
              <a href="#" data-tab="schule">🏫 Schule</a>
            </div>
          </li>

          <li class="nav-item">
            <a href="#">⚙️ Einstellungen</a>
            <div class="dropdown">
              <a href="#" data-tab="settings">🔧 Einstellungen</a>
              <a href="#" id="logoutBtn">🚪 Abmelden</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <main id="mainContent"></main>
    <footer><small>© 2025 Straßenwärter-Helfer</small></footer>
  </div>

  <!-- === AUTH CONFIG (falls genutzt) === -->
  <script>
    window.__AUTH_CONF__ = {
      saltHex: "3f1c8e6a4b9d2f11aabbccdd33445566",
      iterations: 200000,
      derivedB64: "W7QCePmG2MCDRpOgJSjnqGTWa/yyMlKw7Snuh2AfzHo="
    };
  </script>

  <!-- === MODULES === -->
  <script src="scripts/auth.js"></script>
  <script src="scripts/main.js"></script>
  <script src="scripts/dashboard.js"></script>
  <script src="scripts/worktime.js"></script>
  <script src="scripts/calc.js"></script>
  <script src="scripts/kmcalc.js"></script>
  <script src="scripts/rsa.js"></script>
  <script src="scripts/signs.js"></script>
  <script src="scripts/winter.js"></script>
  <script src="scripts/report.js"></script>
  <script src="scripts/ausbildungsnachweis.js"></script>
  <script src="scripts/arp.js"></script>
  <script src="scripts/projectdoc.js"></script>
  <script src="scripts/settings.js"></script>

  <!-- === NAVIGATION LOGIK (mit Event-Delegation) === -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const splash = document.getElementById("splash");
      setTimeout(() => splash?.classList.add("hide"), 4000);

      const nav = document.getElementById("mainNav");
      const navMenu = document.getElementById("navMenu");
      const mobileToggle = document.getElementById("mobileNavToggle");
      const navItems = document.querySelectorAll(".nav-item");

      // MOBILE TOGGLE
      mobileToggle.addEventListener("click", () => {
        navMenu.classList.toggle("show");
        document.body.classList.toggle("menu-open");
        mobileToggle.classList.toggle("active");
      });

      // DESKTOP Hover öffnen/schließen (nur >850px)
      function bindDesktopHover() {
        if (window.innerWidth <= 850) return;
        navItems.forEach(item => {
          const dd = item.querySelector(".dropdown");
          if (!dd) return;
          let hideT;
          item.addEventListener("mouseenter", () => {
            clearTimeout(hideT);
            dd.style.display = "flex";
            requestAnimationFrame(() => {
              dd.style.opacity = "1"; dd.style.pointerEvents = "auto"; dd.style.transform = "translateY(0)";
            });
          });
          item.addEventListener("mouseleave", () => {
            hideT = setTimeout(() => {
              dd.style.opacity = "0"; dd.style.pointerEvents = "none"; dd.style.transform = "translateY(5px)";
              setTimeout(() => (dd.style.display = "none"), 120);
            }, 80);
          });
        });
      }
      bindDesktopHover();

      // MOBILE Untermenüs per Klick auf/zuklappen
      navItems.forEach(item => {
        const parentLink = item.querySelector(":scope > a:not([data-tab])");
        if (!parentLink) return;
        parentLink.addEventListener("click", e => {
          if (window.innerWidth <= 850) {
            e.preventDefault();
            const open = item.classList.contains("open");
            navItems.forEach(i => i.classList.remove("open"));
            if (!open) item.classList.add("open");
          }
        });
      });

      // WICHTIG: EVENT-DELEGATION für ALLE data-tab-Links
      navMenu.addEventListener("click", e => {
        const a = e.target.closest("a[data-tab]");
        if (!a) return;

        // Klick verarbeiten (egal ob im Dropdown oder oben)
        e.preventDefault();

        // Active-Klasse nur auf aktuellem Link
        navMenu.querySelectorAll("a.active").forEach(el => el.classList.remove("active"));
        a.classList.add("active");

        // Mobile Menü schließen
        navMenu.classList.remove("show");
        document.body.classList.remove("menu-open");
        mobileToggle.classList.remove("active");

        // Tab laden
        loadTab(a.dataset.tab);
      });

      // Klick außerhalb schließt mobiles Menü
      document.addEventListener("click", e => {
        if (!e.target.closest("#mainNav") && navMenu.classList.contains("show")) {
          navMenu.classList.remove("show");
          document.body.classList.remove("menu-open");
          mobileToggle.classList.remove("active");
        }
      });

      // Optional: Re-bind bei Resize (wechsel Desktop/Mobile)
      window.addEventListener("resize", () => {
        // Schließe Menüs beim Wechsel
        navMenu.classList.remove("show");
        document.body.classList.remove("menu-open");
        mobileToggle.classList.remove("active");
      });
    });

    // TAB LOADER
    function loadTab(tab) {
      const main = document.getElementById("mainContent");
      main.innerHTML = "<div style='padding:2rem;color:#fff;'>⏳ Lade Inhalt...</div>";
      switch (tab) {
        case "dashboard": if (typeof loadDashboard === "function") loadDashboard(); break;
        case "rsa": if (typeof loadRSA === "function") loadRSA(); break;
        case "signs": if (typeof loadSigns === "function") loadSigns(); break;
        case "infos": if (typeof loadInfos === "function") loadInfos(); break;
        case "calc": if (typeof loadCalc === "function") loadCalc(); break;
        case "worktime": if (typeof loadWorktime === "function") loadWorktime(); break;
        case "schoolcalc": if (typeof loadSchoolCalc === "function") loadSchoolCalc(); break;
        case "winter": if (typeof loadWinter === "function") loadWinter(); break;
        case "report": if (typeof loadReport === "function") loadReport(); break;
        case "ausbildungsnachweis": if (typeof loadAusbildungsnachweis === "function") loadAusbildungsnachweis(); break;
        case "arp": if (typeof loadArp === "function") loadArp(); break;
        case "projectdoc": if (typeof loadProjectDoc === "function") loadProjectDoc(); break;
        case "settings": if (typeof loadSettings === "function") loadSettings(); break;
        default:
          main.innerHTML = `<div style="padding:2rem;text-align:center;color:#fff;"><h2>${tab}</h2><p>Modul nicht gefunden.</p></div>`;
      }
    }
  </script>
</body>
</html>
